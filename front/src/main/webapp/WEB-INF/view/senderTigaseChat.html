<!DOCTYPE html>
<html xmlns="http://java.sun.com/jsf/html">
<head lang="en">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>采料网-上采料,材购好 hello world</title>
    <meta name="keywords" content="cailiao,采料网,hicailiao">
    <meta name="description" content="hicailiao,上采料，材购好">
    <meta name="generator" content="">
    <meta name="author" content="采料网">
    <meta name="copyright" content="采料网">
    <link rel="icon" href="$!web.contextPath/resources/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="$!web.contextPath/resources/css/public.css">
    <link rel="stylesheet" href="$!web.contextPath/resources/css/chat_window.css"/>
    <script src="$!web.contextPath/resources/js/jquery/1.6.2/jquery-1.6.2.js"></script>
	<script src="$!web.contextPath/resources/js/strophe/0.0.1/strophe.js"></script>
    <!--<script src="$!web.contextPath/resources/js/connect/0.0.1/connect.js"></script>-->
    <script src="$!web.contextPath/resources/js/connect/0.0.1/connect2.js"></script>
	#*<script>
        // XMPP服务器BOSH地址
        var BOSH_SERVICE = 'http://192.168.0.130:5280';

        // XMPP连接
        var connection = null;

        // 当前状态是否连接
        var connected = false;

        // 当前登录的JID
        var jid = "";

        var senderUserName = "";

        var receiverUserName = "";

        // 连接状态改变的事件
        function onConnect(status) {
            console.log(status);
            if (status == Strophe.Status.CONNFAIL) {
                alert("连接失败！");
            } else if (status == Strophe.Status.AUTHFAIL) {
                alert("登录失败！");
            } else if (status == Strophe.Status.DISCONNECTED) {
                alert("连接断开！");
                connected = false;
            } else if (status == Strophe.Status.CONNECTED) {
                connected = true;

                // 当接收到<message>节，调用onMessage回调函数
                connection.addHandler(onMessage, null, 'message', null, null, null);

                // 首先要发送一个<presence>给服务器（initial presence）
                connection.send($pres().tree());
            }
        }

        /*function getMessage() {
            if(connected) {
                var msg = $iq({
                    tyep: 'get',
                    id: 'msg'
                }).c('pref', 'xmlns', 'urn:xmpp:archive');
                connection.send(msg.tree());
            }
        }*/

        function inMessage() {
            if(connected) {
                // 创建一个<message>元素并发送
                var text = $("#area1").val();
                var msg = $msg({
                    to: receiverUserName,
                    from: senderUserName,
                    type: 'chat'
                }).c("body", null, text);
                connection.send(msg.tree());

                var date = new Date();

                //聊天框显示
                var message = '<dl class="me m1"><dt>'
                    + '<a href="#"><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>'
                    + '<ul><li>$!senderUserName<span>'
                    +  date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + '</span></li></ul></dt><dd>'
                    + escape(text) +'</dd></dl>';

                $("#msg").append(message);
                $("#input-msg").val('');
            } else {
                alert("请先登！");
            }
        }

        // 接收到<message>
        function onMessage(msg) {

            // 解析出<message>的from、type属性，以及body子元素
            var type = msg.getAttribute('type');
            var elems = msg.getElementsByTagName('body');
            var date = new Date();

            if (type == "chat" && elems.length > 0) {
                var body = elems[0];
                var message_seller='<dl class="vhe m1"><dt>'
                    + '<a href="#"><img src="$!web.contextPath/resources/images/chat4.png" alt=""/></a>'
                    + '<ul><li>$!receiverUserName<span>'
                    +  date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + '</span></li></ul></dt><dd>'
                    + escape(Strophe.getText(body)) +'</dd></dl>';
                $("#msg").append(message_seller);
            }
            return true;
        }

        function escape(text) {
            text = text.replace(/&/g, '&amp;');
            text = text.replace(/</g, '&lt;');
            text = text.replace(/>/g, '&gt;');
            text = text.replace(/"/g, '&quot;');
            text = text.replace(/'/g, '&#039;');
            return text;
        }

        $(document).ready(function() {

            senderUserName = jQuery("#senderUserName").val() + "@192.168.0.130";
            receiverUserName = jQuery("#receiverUserName").val() + "@192.168.0.130";

            // 通过BOSH连接XMPP服务器
            if(!connected) {
                connection = new Strophe.Connection(BOSH_SERVICE);
                connection.connect(senderUserName , "", onConnect);
                jid = senderUserName;
            }
        });
	</script>*#
</head>
<body>
    <div class="chat_body">
        <div class="chat_content_left">
            <div class="chat_left_top">
                <dl>
                    <dt><img src="$!web.contextPath/resources/images/upfile/chat_seller.png" alt=""/></dt>
                    <dd>$!senderUserName</dd>
					<input type="hidden" id="senderUserName" value="wuxun">
                </dl>
                <p>
                    <img src="$!web.contextPath/resources/images/chat_search.png" alt=""/>
                    <input type="text" placeholder="搜索联系人"/>
                </p>
            </div>
            <div class="chat_left_content" id="chat_left_content">
                <dl id="hicailiao" chat_id="tabcon1" class="tabon" onclick="switchTab(this)">
                    <dt><img src="$!web.contextPath/resources/images/upfile/chat_buyer.png" alt=""/></dt>
                    <dd>
                        <p>
                            <strong>$!receiverUserName</strong><span>15:20</span>
							<input type="hidden" id="receiverUserName" value="hicailiao">
                        </p>
                        <h1>请问多久收到...</h1>
                    </dd>
                    <p></p>
                </dl>
            </div>
            <p class="db ov cl"></p>
        </div>
        <div class="chat_content_middle">
            <div id="tabcon1">
                <div class="chat_top">
                    <dl>
                        <dt>宏利建材旗舰店<span class="online">在线</span></dt>
                        <dd class="chat_top1"><img src="$!web.contextPath/resources/images/chat1.png" alt=""/></dd>
                    </dl>
                </div>
                <div class="chat_content_center">
                    <dl class="chat_center1">
                        <dt><img src="$!web.contextPath/resources/images/chat2.png" alt=""/></dt>
                        <dd>客服<span>$!receiverUserName</span>已加入会话</dd>
                    </dl>
                    <div class="m" area_id="area1" id="msg">
                        #*<dl class="vhe m1">
                            <dt>
                                <a href="#"><img src="$!web.contextPath/resources/images/chat4.png" alt=""/></a>
                            <ul>
                                <li>宏利建材旗舰店<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>您好，请问有什么可以帮您？</dd>
                        </dl>
                        <dl class="me m1">
                            <dt>
                                <a><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>
                            <ul>
                                <li>我是用户<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>请问发货后多久能收到呢？</dd>
                        </dl>
                        <dl class="vhe m1">
                            <dt>
                                <a href="#"><img src="$!web.contextPath/resources/images/chat4.png" alt=""/></a>
                            <ul>
                                <li>宏利建材旗舰店<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>亲 收到货后 安装蚊帐前先用湿毛巾擦一下支架，再安装喔。有的时候支架上
                                会残留一些纤维粉末，安装的时候可能会扎到手
                                <a class="chat_anquan" href="#">
                                    <img src="$!web.contextPath/resources/images/chat10.png" alt=""/>
                                    <span>https://www.hicailiao.com/goods_99651.htm</span>
                                </a>
                            </dd>
                        </dl>
                        <dl class="me m1">
                            <dt><a><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>
                            <ul>
                                <li>我是用户<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>请问发货后多久能收到呢？</dd>
                        </dl>
                        <dl class="me m1">
                            <dt><a><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>
                            <ul>
                                <li>我是用户<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>请问发货后多久能收到呢？</dd>
                        </dl>
                        <dl class="vhe m1">
                            <dt>
                                <a href="#"><img src="$!web.contextPath/resources/images/chat4.png" alt=""/></a>
                            <ul>
                                <li>宏利建材旗舰店<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>亲 收到货后 安装蚊帐前先用湿毛巾擦一下支架，再安装喔。有的时候支架上
                                会残留一些纤维粉末，安装的时候可能会扎到手
                                <a class="chat_anquan" href="#"><img src="$!web.contextPath/resources/images/chat10.png" alt=""/><span>https://www.hicailiao.com/goods_99651.htm</span></a>
                            </dd>
                        </dl>
                        <dl class="me m1">
                            <dt><a><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>
                            <ul>
                                <li>我是用户<span>14：50：30</span></li>
                            </ul>
                            </dt>
                            <dd>请问发货后多久能收到呢？</dd>
                        </dl>*#
                    </div>
                    <!-- 发送消息-->
                    <div class="edit">
                        <img src="$!web.contextPath/resources/images/chat11.png" width="17" height="17" alt=""/>
                        <img src="$!web.contextPath/resources/images/chat12.png" width="19" height="19" alt=""/>
                        <img src="$!web.contextPath/resources/images/chat13.png" width="23" height="20" alt=""/>
                        <img src="$!web.contextPath/resources/images/chat14.png" width="23" height="20" alt=""/>
                    </div>
                    <div class="chat_text">
                        <textarea maxlength="300" id="area1"></textarea>
                        <input type="button" dl_id="a1" class="close" value="关闭" onclick="confirm1(this);"/>
                        <div class="send">
                            <span  textarea_id="area1" onclick="send1(this);">发送</span>
                            <div class="send-method"><img src="$!web.contextPath/resources/images/chat15.png" alt=""/></div>
                        </div>
                        <div class="send-method-box">
                            <div class="send-method-text"><a onclick="setTriggerEnter(true);">按Enter键发送消息</a></div>
                            <div class="send-method-text"><a onclick="setTriggerEnter(false);">按Ctrl+Enter键发送消息</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat_content">
            <div class="nav_title_all">
                <ul class="menu0" id="menu0">
                    <li onclick="Tab(0,0)" class="hover">商品详情</li>
                    <li onclick="Tab(0,1)" >我的订单</li>
                </ul>
                <div id="main0">
                    <ul class="block">
                        <li class="nav_title"><a href=""><img src="$!web.contextPath/resources/images/chat6.png" width="122" height="92" alt="" class="goods_detail"/>
                            <span>乐视超级电视超3K40英寸智能LED液晶智电视 乐视tv(1年服务费版)</span></a>
                            <input type="button" class="cart" value="加入购物车">
                        </li>

                    </ul>
                    <ul>
                        <li class="nav_title">
                            <div class="nav_title1">
                                <span>订单状态：</span>
                                <span>待付款</span>
                            </div>
                            <div>
                                <span>订单编号：</span>
                                <span class="nav_title2">
                                    <a href="">3278420160321163138</a>
                                </span>
                            </div>
                            <div>
                                <span>订单金额：</span>
                                <span>&yen;7.50</span>
                            </div>
                            <div>
                                <span>支付方式：</span>
                                <span class="order_detail">支付宝</span>
                            </div>
                            <div>
                                <span class="nav_title3">收货人：</span>
                                <span class="order_detail">范先生</span>
                            </div>
                            <div>
                                <span>下单时间：</span>
                                <span class="order_detail">2016-03-21 16:31:39</span>
                            </div>
                            <div>
                                <span>下单商品：</span>
                                <span><img src="$!web.contextPath/resources/images/chat16.png" width="41" height="42" alt=""/></span>
                                <span class="nav_title4">共1件</span>
                            </div>
                            <div>
                                <span class="nav_title5"><a href="">更多&raquo;</a></span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        function Tab(m,n){
            var tli=document.getElementById("menu"+m).getElementsByTagName("li");
            var mli=document.getElementById("main"+m).getElementsByTagName("ul");
            for(i=0;i<tli.length;i++){
                tli[i].className=i==n?"hover":"";
                mli[i].style.display=i==n?"block":"none";
            }
        }
    </script>
    <script>
        jQuery(document).ready(function(){

            //滚动条
            jQuery(".m").each(function(){
                this.scrollTop = this.scrollHeight;
            });

            //切换选项卡
            $(".chat_left_content dl").click(function(){
                $(this).siblings().removeClass("tabon");
                $(this).addClass("tabon");
                var chattab = $("#"+$(this).attr("chat_id"));
                chattab.siblings().hide();
                chattab.show();
                var m = chattab.find(".m")[0];
                m.scrollTop = m.scrollHeight;
            });

            //enter 发送
            $('textarea').bind('keydown', function () {
                var e=arguments.callee.caller.arguments[0]||window.event;
                var keyCode = e.keyCode || e.which || e.charCode;
                var ctrlKey = e.ctrlKey || e.metaKey;
                var triggerEnter = getTriggerEnter(); // enter 触发

                if (triggerEnter && keyCode == 13 || !triggerEnter && ctrlKey && keyCode == 13) {
                    send2(this);
                    e.preventDefault();
                }
            });

            //发送按钮
            function stopPropagation(e) {
                if (e.stopPropagation)
                    e.stopPropagation();//停止冒泡  非ie
                else
                    e.cancelBubble = true;//停止冒泡 ie
            }
            $(document).bind('click',function(){
                $('.send-method-box').css('display','none');
            });
            $('.send-method').each(function(index,val){
                $(val).bind('click',function(e){
                    stopPropagation(e);//调用停止冒泡方法,阻止document方法的执行
                    $('.send-method-box').css('display','block');
                });
            });
        });

        //关闭对话框
        function confirm1(obj) {
            if (confirm("确定关闭此对话框吗？")) {
                var left_dl =  $("#" + $(obj).attr("dl_id"));
                if(left_dl.next()[0]) {
                    left_dl.next().removeAttr("class").attr("class", "tabon");
                    $("#" + left_dl.next().attr("chat_id")).show();
                } else if (left_dl.prev()[0]){
                    left_dl.prev().removeAttr("class").attr("class", "tabon");
                    $("#" + left_dl.prev().attr("chat_id")).show();
                } else {
                    return;
                }
                left_dl.remove();
                var right_chat = $("#" + left_dl.attr("chat_id"));
                if (right_chat.siblings().size() == 1) {
                    right_chat.siblings().find(".close").css("visibility","hidden");
                }
                right_chat.remove();
            }
        }

        var triggerEnter = true;
        function setTriggerEnter(val) {
            triggerEnter = val;
        }
        function getTriggerEnter() {
            return triggerEnter;
        }

        //发送消息
        function send1(obj) {
            send2(jQuery("#" + jQuery(obj).attr("textarea_id"))[0]);
        }

        function send2(src) {
            var target = $("div[area_id=" + src.id + "]")[0];
            /*var text = src.value;
            var date = new Date();
            var message = '<dl class="me m1"><dt>'
                    + '<a href="#"><img src="$!web.contextPath/resources/images/chat7.png" alt=""/></a>'
                    + '<ul><li>$!senderUserNname<span>'
                    +  date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + '</span></li></ul></dt><dd>'
                    + escape(text) +'</dd></dl>';

            $(target).append(message);*/
            inMessage();
            src.value = "";
            target.scrollTop = target.scrollHeight;

            // 模拟卖家回复
            /*setTimeout(function() {
                receive(target, "回复 " + text);
            }, 500);*/
        }

        function escape(text) {
            text = text.replace(/&/g, '&amp;');
            text = text.replace(/</g, '&lt;');
            text = text.replace(/>/g, '&gt;');
            text = text.replace(/"/g, '&quot;');
            text = text.replace(/'/g, '&#039;');
            return text;
        }

        function receive(target, message) {
            var date = new Date();
            var message_seller='<dl class="vhe m1"><dt>'
                    + '<a href="#"><img src="$!web.contextPath/resources/images/chat4.png" alt=""/></a>'
                    + '<ul><li>宏利建材旗舰店<span>'
                    +  date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + '</span></li></ul></dt><dd>'
                    + escape(message) +'</dd></dl>';
            $(target).append(message_seller);
            target.scrollTop = target.scrollHeight;
        }
    </script>
</body>
</html>
